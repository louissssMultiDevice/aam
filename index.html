<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Handi Dev • Device Insight — Ultra+ (All-in-One)</title>
  <meta name="theme-color" content="#071018" />
  <style>
    /* ============================
       THEME & LAYOUT
       Single-file, compact & responsive
       ============================ */
    :root{
      --bg:#071018; --card:#0f1720; --text:#dff8f6; --muted:#9fbfc8;
      --accent:#00ffc6; --accent-2:#00c2ff;
    }
    [data-theme='light']{--bg:#f6fbff;--card:#fff;--text:#032027;--muted:#4b6b74}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#071018);color:var(--text)}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001}
    h1{margin:0;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;padding:8px 10px;border-radius:8px;color:#001;font-weight:700;cursor:pointer}
    .toggle{background:var(--card);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:16px}
    .card{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:84px}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .footer{margin:22px 0;color:var(--muted);font-size:13px}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;backdrop-filter:blur(4px);visibility:hidden;opacity:0;transition:all .18s}
    .overlay.show{visibility:visible;opacity:1}
    .loader{background:var(--card);padding:18px;border-radius:12px;display:flex;gap:12px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);animation:blink 1s infinite}
    @keyframes blink{50%{opacity:0.25;transform:scale(.8)}}
    /* charts area */
    .charts-section{margin-top:20px;padding-top:16px;border-top:1px dashed rgba(255,255,255,0.04)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
    .tab.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#001}
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
    .chart-card{background:var(--card);padding:12px;border-radius:8px;min-height:200px;border:1px solid rgba(255,255,255,0.03)}
    canvas{width:100%!important;height:220px!important}
    #three3d{width:100%;height:360px;border-radius:8px;display:block;background:#000}
    @media (max-width:920px){#three3d{height:240px}}
    /* utility */
    .muted{color:var(--muted);font-size:12px}
  </style>
</head>
<body data-theme="dark">
  <div class="wrap" id="app">
    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo">HD+</div>
        <div>
          <h1>Handi Dev • Device Insight — Ultra+</h1>
          <div class="subtitle">Detect mendalam + grafik 2D & 3D — all-in-one</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="themeBtn">Toggle Theme</button>
        <button class="btn" id="copyAll">Copy All</button>
        <button class="btn" id="exportAllJSON">Export JSON</button>
        <button class="btn" id="toggleCharts">Open Charts</button>
      </div>
    </header>

    <!-- BASIC INFO GRID -->
    <div class="grid" id="infoGrid" style="margin-top:12px">
      <div class="card">
        <h3>Device & Browser</h3>
        <div class="mono" id="ua">—</div>
        <div class="small" id="device">—</div>
      </div>

      <div class="card">
        <h3>Network & IP</h3>
        <div class="mono v" id="ip">—</div>
        <div class="small">Status: <span id="online">—</span> • Downlink: <span id="downlink">—</span></div>
        <div style="margin-top:8px" class="row">
          <button class="btn" id="btn-ip">Refresh IP</button>
          <button class="btn" id="pingBtn">Ping</button>
          <button class="btn" id="speedBtn">Speed</button>
        </div>
        <div class="small" id="netRes">—</div>
      </div>

      <div class="card">
        <h3>Battery</h3>
        <div class="v" id="battery-level">—</div>
        <div class="small" id="battery-status">—</div>
      </div>

      <div class="card">
        <h3>Performance</h3>
        <div class="v" id="sys">—</div>
        <div class="small">Cores: <span id="cores">—</span> • RAM: <span id="ram">—</span> GB • Heap: <span id="heap">—</span></div>
      </div>

      <div class="card">
        <h3>Sensors</h3>
        <div id="sensorVal" class="v">—</div>
        <div class="small">Accelerometer / Orientation / Light</div>
      </div>

      <div class="card">
        <h3>Security</h3>
        <div id="incognito" class="v">—</div>
        <div id="secureNotes" class="small">Proxy / VPN heuristic</div>
      </div>
    </div>

    <!-- ADVANCED DETECT -->
    <div class="grid" style="margin-top:18px">
      <div class="card">
        <h3>Deep Fingerprint</h3>
        <div class="mono v" id="fingerprint">—</div>
        <div class="small">Canvas • Audio • WebGL • Fonts • Timezone • UA</div>
        <div style="margin-top:8px" class="row">
          <button class="btn" id="runCanvas">Canvas FP</button>
          <button class="btn" id="runAudio">Audio FP</button>
          <button class="btn" id="runAllFP">All FP</button>
        </div>
      </div>

      <div class="card">
        <h3>WebGL & GPU</h3>
        <div id="gpu" class="v">—</div>
        <div class="small">Shader precision: <span id="shaderPrec">—</span></div>
      </div>

      <div class="card">
        <h3>Font Detection</h3>
        <div id="fonts" class="v">—</div>
        <div class="small">Mendeteksi font populer</div>
      </div>

      <div class="card">
        <h3>AI Insight</h3>
        <div id="aiInsight" class="v">—</div>
        <div class="small">Heuristik otomatis berdasarkan data</div>
      </div>

      <div class="card">
        <h3>Biometric & WebAuthn</h3>
        <div id="webauthn" class="v">—</div>
        <div class="small">Platform authenticator</div>
      </div>

      <div class="card">
        <h3>WebXR / VR</h3>
        <div id="webxr" class="v">—</div>
        <div class="small">WebXR support detection</div>
      </div>
    </div>

    <!-- CHARTS SECTION (BOTTOM) -->
    <div class="charts-section" id="chartsSection" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tabs" role="tablist">
          <div class="tab active" data-tab="2d">📊 Grafik 2D</div>
          <div class="tab" data-tab="3d">🌀 Grafik 3D</div>
        </div>
        <div class="row">
          <button class="btn" id="exportVisualPNG">Export Snapshot</button>
          <button class="btn" id="closeCharts">Close Charts</button>
        </div>
      </div>

      <!-- 2D -->
      <div id="tab-2d">
        <div class="chart-grid" style="margin-top:12px">
          <div class="chart-card">
            <h4>FPS & JS Heap</h4>
            <canvas id="fpsChart"></canvas>
            <div class="small">Line chart: FPS & Heap (MB).</div>
          </div>

          <div class="chart-card">
            <h4>Battery & Speed</h4>
            <canvas id="batteryNetChart"></canvas>
            <div class="small">Battery history & speed bars.</div>
          </div>

          <div class="chart-card">
            <h4>Acceleration (X/Y/Z)</h4>
            <canvas id="accelChart"></canvas>
            <div class="small">Accelerometer (radar).</div>
          </div>

          <div class="chart-card">
            <h4>Canvas Mosaic</h4>
            <canvas id="canvasMosaic" style="height:180px"></canvas>
            <div class="small">Visual fingerprint mosaic.</div>
          </div>

          <div class="chart-card">
            <h4>TF.js Inference Heatmap</h4>
            <canvas id="heatmapChart"></canvas>
            <div class="small">Micro-benchmark (ms).</div>
          </div>
        </div>
      </div>

      <!-- 3D -->
      <div id="tab-3d" style="display:none; margin-top:12px">
        <div class="chart-card">
          <h4>3D Scene — Cube & Speed Bars</h4>
          <div id="three3d"></div>
          <div class="small">Klik & drag untuk rotate; zoom with wheel.</div>
        </div>
      </div>
    </div>

    <div class="footer">Catatan: beberapa fitur memerlukan izin. Data disimpan lokal kecuali di-export.</div>
  </div>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay"><div class="loader"><div class="dot"></div><div><div id="overlayTxt">Loading…</div><div class="small">Mohon tunggu</div></div></div></div>

  <!-- ============================
       SCRIPT (all-in-one)
       ============================ -->
  <script>
  /* ============================
     Helpers & small utilities
     ============================ */
  const $ = id => document.getElementById(id);
  function setText(id, v){ const el = $(id); if(el) el.textContent = v; }
  function showOverlay(txt){ $('overlay').classList.add('show'); $('overlayTxt').textContent = txt || 'Loading…'; }
  function hideOverlay(){ $('overlay').classList.remove('show'); }

  /* ----------------------------
     Basic UI wiring
     ---------------------------- */
  (function initUI(){
    // theme toggle
    $('themeBtn').addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      const nxt = cur === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', nxt);
    });

    // copy & export
    $('copyAll').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(JSON.stringify(collectSnapshot(), null, 2)); alert('Disalin ke clipboard'); }catch(e){ alert('Gagal salin: '+(e.message||e)); }
    });
    $('exportAllJSON').addEventListener('click', ()=>{ downloadJSON('handidev-all.json', collectSnapshot()); });

    // charts toggles & tabs
    $('toggleCharts').addEventListener('click', ()=>{ $('chartsSection').style.display='block'; document.querySelector('.tab[data-tab="2d"]').click(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); });
    $('closeCharts').addEventListener('click', ()=>{ $('chartsSection').style.display='none'; });
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', async ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        if(tab === '2d'){ $('tab-2d').style.display=''; $('tab-3d').style.display='none'; if(!window._fpsChartInited) await init2DCharts(); }
        else { $('tab-2d').style.display='none'; $('tab-3d').style.display=''; if(!window._threeInited) await initThree(); }
      });
    });

    $('exportVisualPNG').addEventListener('click', ()=>{
      // export fpsChart if exists, else battery chart
      const c = document.querySelector('#fpsChart') || document.querySelector('#batteryNetChart');
      if(c && c.toDataURL){
        const data = c.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download='handidev-chart.png'; a.click();
      } else alert('Chart belum siap untuk diekspor.');
    });
  })();

  /* ----------------------------
     Snapshot collector
     ---------------------------- */
  function collectSnapshot(){
    return {
      ts: new Date().toISOString(),
      ua: navigator.userAgent,
      platform: navigator.platform,
      cores: navigator.hardwareConcurrency || null,
      ram: navigator.deviceMemory || null,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      fingerprint: $('fingerprint')?.textContent || null
    };
  }
  function downloadJSON(filename, obj){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'})); a.download = filename; a.click(); }

  /* ============================
     Basic detection hooks
     ============================ */
  // UA / device
  setText('ua', navigator.userAgent);
  setText('device', navigator.platform || '—');
  setText('cores', navigator.hardwareConcurrency || '—');
  setText('ram', navigator.deviceMemory || '—');

  // battery
  (async function batteryInit(){
    try{
      if('getBattery' in navigator){
        const b = await navigator.getBattery();
        function paint(){
          setText('battery-level', Math.round(b.level*100)+'%');
          setText('battery-status', b.charging ? 'Charging' : 'Discharging');
        }
        ['levelchange','chargingchange'].forEach(e=>b.addEventListener(e,paint));
        paint();
      } else { setText('battery-level','—'); setText('battery-status','Not supported'); }
    }catch(e){ setText('battery-level','—'); setText('battery-status','Error'); }
  })();

  // network ip
  async function fetchIP(){
    try{
      showOverlay('Mengambil IP publik...');
      const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json();
      setText('ip', j.ip || '—');
    }catch(e){ setText('ip','Gagal ambil IP'); } finally { hideOverlay(); }
  }
  $('btn-ip').addEventListener('click', fetchIP);
  fetchIP();

  // connection status
  function paintNet(){
    const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    setText('online', navigator.onLine? 'online' : 'offline');
    setText('downlink', c?.downlink ?? '—');
  }
  paintNet();
  (navigator.connection||{}).addEventListener?.('change', paintNet);
  window.addEventListener('online', paintNet);
  window.addEventListener('offline', paintNet);

  // heap
  async function paintHeap(){ try{ if(performance?.memory){ setText('heap', (performance.memory.usedJSHeapSize/1024/1024).toFixed(1) + ' MB'); } else setText('heap','N/A'); }catch(e){ setText('heap','—'); } }
  setInterval(paintHeap,1500); paintHeap();

  // sensors
  const accelBuffer = [];
  function pushAccelSample(s){ accelBuffer.push(s); if(accelBuffer.length>60) accelBuffer.shift(); }
  if('DeviceMotionEvent' in window){
    window.addEventListener('devicemotion', e=>{
      const a = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
      setText('sensorVal', `X:${(a.x||0).toFixed(2)} Y:${(a.y||0).toFixed(2)} Z:${(a.z||0).toFixed(2)}`);
      pushAccelSample({x:a.x||0,y:a.y||0,z:a.z||0});
    });
  }

  // incognito heuristic
  (async function incognitoCheck(){
    try{
      const fs = window.RequestFileSystem || window.webkitRequestFileSystem;
      if(!fs){
        const key = 'handi_test';
        try{ localStorage.setItem(key,'1'); localStorage.removeItem(key); setText('incognito','Normal (localStorage OK)'); return; }
        catch(err){ setText('incognito','Private/Restricted (localStorage failure)'); return; }
      }
      fs(window.TEMPORARY,100, ()=>setText('incognito','Normal'), ()=>setText('incognito','Incognito/Private'));
    }catch(e){ setText('incognito','Tidak pasti') }
  })();

  // AI heuristics
  function aiAnalysis(){ const cores = navigator.hardwareConcurrency||2; const ram = navigator.deviceMemory||2; const heap = (performance?.memory?.usedJSHeapSize||0)/1024/1024; const notes=[]; if(ram<2) notes.push('RAM terbatas'); else if(ram>=8) notes.push('RAM besar'); if(cores<=2) notes.push('CPU sedikit'); else notes.push('CPU cukup'); if(heap>300) notes.push('Heap tinggi'); setText('aiInsight', notes.join(' • ') || 'Normal'); }
  aiAnalysis(); setInterval(aiAnalysis,10000);

  /* ============================
     Deep fingerprint utilities
     ============================ */
  function canvasFingerprint(){
    try{
      const c = document.createElement('canvas'); c.width=512; c.height=200;
      const ctx = c.getContext('2d');
      ctx.textBaseline='top';
      ctx.font="16px Arial";
      ctx.fillStyle='#f60'; ctx.fillRect(125,1,62,20);
      ctx.fillStyle='#069'; ctx.fillText('Handi Dev — Canvas FP', 2, 15);
      ctx.fillStyle='rgba(102,200,0,0.7)'; ctx.fillText('✓ 測試 — 𝓕𝓟', 4, 45);
      return c.toDataURL().slice(-120);
    }catch(e){ return null; }
  }

  function getWebGLInfo(){
    try{
      const c = document.createElement('canvas');
      const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
      if(!gl) return null;
      const dbg = gl.getExtension('WEBGL_debug_renderer_info');
      const vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR);
      const renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
      return {vendor, renderer};
    }catch(e){ return null; }
  }

  async function audioFingerprint(){
    try{
      const ac = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ac.createOscillator();
      const node = ac.createAnalyser();
      osc.type='sine'; osc.frequency.value = 440 + (Math.random()*100);
      osc.connect(node); node.connect(ac.destination); osc.start();
      const arr = new Uint8Array(node.frequencyBinCount);
      node.getByteFrequencyData(arr); osc.stop(); await ac.close?.();
      return Array.from(arr.slice(0,20)).join(',').slice(0,80);
    }catch(e){ return null; }
  }

  function detectFont(font){
    const base = document.createElement('span');
    base.style.fontFamily='monospace'; base.style.fontSize='72px'; base.innerText='mmmmmmmmmlli';
    base.style.position='absolute'; base.style.left='-9999px';
    document.body.appendChild(base);
    const defaultWidth = base.offsetWidth;
    base.style.fontFamily = font + ', monospace';
    const matched = base.offsetWidth !== defaultWidth;
    base.remove();
    return matched;
  }
  function detectFontsList(){
    const fonts = ['Arial','Roboto','Segoe UI','Times New Roman','Courier New','Noto Sans','Inter'];
    try{ return fonts.filter(f=>detectFont(f)); }catch(e){ return []; }
  }

  // FP UI buttons
  $('runCanvas').addEventListener('click', ()=>{
    const c = canvasFingerprint(); if(c) setText('fingerprint', c.slice(0,28)); else setText('fingerprint','Gagal');
    try{ const gl = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl'); const highp = gl && (gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.HIGH_FLOAT).precision > 0); setText('shaderPrec', highp ? 'highp' : 'mediump/lowp'); }catch(e){ setText('shaderPrec','—'); }
  });

  $('runAudio').addEventListener('click', async ()=>{
    setText('audioFP','Running...');
    const a = await audioFingerprint(); setText('audioFP', a || 'Gagal');
  });

  $('runAllFP').addEventListener('click', async ()=>{
    setText('fingerprint','Running...');
    const webgl = getWebGLInfo(); const canvas = canvasFingerprint(); const audio = await audioFingerprint(); const fonts = detectFontsList();
    const base = navigator.userAgent + '|' + navigator.language + '|' + JSON.stringify(webgl) + '|' + (canvas||'') + '|' + (audio||'') + '|' + fonts.join(',');
    const h = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(base));
    const hex = Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
    setText('fingerprint', hex.slice(0,28));
    setText('fonts', fonts.join(', ') || '—');
    setText('canvasHash', canvas || '—');
    setText('audioFP', audio || '—');
  });

  // webgl summary initial
  (function setWebGLSummary(){
    const w = getWebGLInfo();
    if(w) setText('gpu', `${w.renderer||'—'} (${w.vendor||'—'})`); else setText('gpu','Not available');
    try{ const glTest = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl'); if(glTest){ const p = glTest.getShaderPrecisionFormat(glTest.FRAGMENT_SHADER, glTest.HIGH_FLOAT); setText('shaderPrec', (p && p.precision>0) ? 'highp' : 'mediump/lowp'); } }catch(e){}
  })();

  // webauthn & webxr checks
  (async function checkWebAPIs(){
    setText('webauthn', !!window.PublicKeyCredential ? 'Supported' : 'Not supported');
    try{ if(navigator.xr && navigator.xr.isSessionSupported){ const sup = await navigator.xr.isSessionSupported('immersive-vr'); setText('webxr', sup ? 'VR Supported' : 'No VR'); } else setText('webxr','No WebXR') }catch(e){ setText('webxr','Error') }
  })();

  /* ============================
     Visualization: 2D & 3D
     - Chart.js & Three.js are loaded on-demand
     - Expose window.__pushSpeed and window.__pushTF to feed data
     ============================ */

  // data buffers
  const maxPoints = 60;
  const fpsHistory = Array(maxPoints).fill(null);
  const heapHistory = Array(maxPoints).fill(null);
  const batteryHistory = Array(maxPoints).fill(null);
  const speedHistory = Array(maxPoints).fill(0);
  const accelHistory = Array(maxPoints).fill({x:0,y:0,z:0});
  const tfHeat = Array(maxPoints).fill(null);

  function pushLimited(arr, v){ arr.push(v); if(arr.length>maxPoints) arr.shift(); }

  // fps sampler & heap sampling
  let frames = 0, lastT = performance.now();
  function fpsLoop(now){
    frames++;
    if(now - lastT >= 1000){
      pushLimited(fpsHistory, frames);
      frames = 0;
      lastT = now;
      try{ if(performance?.memory) pushLimited(heapHistory, performance.memory.usedJSHeapSize/1024/1024); else pushLimited(heapHistory, null); }catch(e){ pushLimited(heapHistory, null); }
      update2DCharts();
      updateThreeVisual();
    }
    requestAnimationFrame(fpsLoop);
  }
  requestAnimationFrame(fpsLoop);

  // battery watch
  (async function batteryWatch(){
    try{
      if('getBattery' in navigator){
        const b = await navigator.getBattery();
        function p(){ pushLimited(batteryHistory, Math.round(b.level*100)); update2DCharts(); }
        ['levelchange','chargingchange'].forEach(e=>b.addEventListener(e,p)); p();
      }
    }catch(e){}
  })();

  // speed connector
  window.__pushSpeed = function(kb){ pushLimited(speedHistory, kb); update2DCharts(); };

  // accel push from sensor
  function pushAccelSample(sample){ pushLimited(accelHistory, sample); updateAccelChart(); }

  // TF push
  window.__pushTF = function(ms){ pushLimited(tfHeat, ms); update2DCharts(); };

  /* ---- Chart.js (lazy load) ---- */
  let ChartJS = null, fpsChart=null, batteryNetChart=null, accelChart=null, heatmapChart=null, canvasCtx=null;
  async function ensureChartJs(){
    if(window.Chart) return window.Chart;
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    return window.Chart;
  }

  async function init2DCharts(){
    if(window._fpsChartInited) return;
    ChartJS = await ensureChartJs();
    // FPS chart
    const ctxF = document.getElementById('fpsChart').getContext('2d');
    fpsChart = new ChartJS(ctxF, {
      type:'line',
      data:{ labels: Array(maxPoints).fill(''), datasets:[
        {label:'FPS', data: fpsHistory, borderColor:'#00ffc6', tension:0.25, fill:false},
        {label:'Heap MB', data: heapHistory, borderColor:'#00c2ff', tension:0.25, fill:false, yAxisID:'y1'}
      ]},
      options:{animation:false, scales:{y:{beginAtZero:true}, y1:{position:'right', beginAtZero:true}}}
    });

    // Battery & speed
    const ctxB = document.getElementById('batteryNetChart').getContext('2d');
    batteryNetChart = new ChartJS(ctxB, {
      data:{ labels: Array(maxPoints).fill(''), datasets:[
        {type:'line', label:'Battery %', data: batteryHistory, borderColor:'#6ef37b', fill:false, yAxisID:'batt'},
        {type:'bar', label:'Speed KB/s', data: speedHistory, backgroundColor:'#00c2ff', yAxisID:'speed'}
      ]},
      options:{animation:false, scales:{batt:{type:'linear', position:'left', beginAtZero:true, max:100}, speed:{type:'linear', position:'right', beginAtZero:true}}}
    });

    // Accel radar
    const ctxA = document.getElementById('accelChart').getContext('2d');
    accelChart = new ChartJS(ctxA, {
      type:'radar',
      data:{ labels:['X','Y','Z'], datasets:[{label:'Accel', data:[0,0,0], backgroundColor:'rgba(0,194,255,0.12)', borderColor:'#00c2ff'}] },
      options:{animation:false, scales:{r:{beginAtZero:true}}}
    });

    // canvas mosaic prepare
    const c = document.getElementById('canvasMosaic');
    canvasCtx = c.getContext('2d');
    drawCanvasMosaic();

    // heatmap simple (bar chart)
    const ctxH = document.getElementById('heatmapChart').getContext('2d');
    heatmapChart = new ChartJS(ctxH, {
      type:'bar',
      data:{ labels:Array(maxPoints).fill(''), datasets:[{label:'TF Inference (ms)', data: tfHeat, backgroundColor:'#ffb86b'}] },
      options:{animation:false, scales:{y:{beginAtZero:true}}}
    });

    window._fpsChartInited = true;
    update2DCharts();
  }

  function drawCanvasMosaic(){
    try{
      const canvas = document.getElementById('canvasMosaic'); const ctx = canvasCtx;
      const w = canvas.width = canvas.clientWidth * devicePixelRatio;
      const h = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      const tmp = document.createElement('canvas'); tmp.width=200; tmp.height=80;
      const t = tmp.getContext('2d'); t.fillStyle='#071018'; t.fillRect(0,0,tmp.width,tmp.height);
      t.fillStyle='#00ffc6'; t.font='20px Arial'; t.fillText('HD Ultra+',10,30);
      const img = new Image();
      img.onload = ()=>{ const cols=8, rows=3, cw=w/cols, ch=h/rows; for(let y=0;y<rows;y++) for(let x=0;x<cols;x++) ctx.drawImage(img, x*cw, y*ch, cw, ch); };
      img.src = tmp.toDataURL();
    }catch(e){}
  }

  function update2DCharts(){
    if(fpsChart){ fpsChart.data.datasets[0].data = fpsHistory.slice(); fpsChart.data.datasets[1].data = heapHistory.slice(); fpsChart.update('none'); }
    if(batteryNetChart){ batteryNetChart.data.datasets[0].data = batteryHistory.slice(); batteryNetChart.data.datasets[1].data = speedHistory.slice(); batteryNetChart.update('none'); }
    if(heatmapChart){ heatmapChart.data.datasets[0].data = tfHeat.slice(); heatmapChart.update('none'); }
    updateAccelChart();
  }

  function updateAccelChart(){
    if(accelChart){
      const last = accelHistory[accelHistory.length-1] || {x:0,y:0,z:0};
      accelChart.data.datasets[0].data = [Math.abs(last.x), Math.abs(last.y), Math.abs(last.z)];
      accelChart.update('none');
    }
  }

  /* ---- Three.js 3D (lazy) ---- */
  let threeReady=false, THREElib=null;
  let scene, camera, renderer, cube, barsGroup = [];
  async function initThree(){
    if(threeReady) return;
    showOverlay('Loading 3D engine...');
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/examples/js/controls/OrbitControls.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    THREElib = window.THREE; threeReady = true;
    hideOverlay();

    const container = document.getElementById('three3d');
    renderer = new THREElib.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.innerHTML = ''; container.appendChild(renderer.domElement);

    scene = new THREElib.Scene();
    camera = new THREElib.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0,2,6);

    const light = new THREElib.DirectionalLight(0xffffff, 1);
    light.position.set(5,10,7);
    scene.add(light);
    scene.add(new THREElib.AmbientLight(0x404040));

    const geometry = new THREElib.BoxGeometry(1.4,1.4,1.4);
    const material = new THREElib.MeshStandardMaterial({color:0x00ffc6, metalness:0.3, roughness:0.6});
    cube = new THREElib.Mesh(geometry, material);
    cube.position.set(-2,0,0); scene.add(cube);

    // bars
    const barCount = 12;
    const barGroup = new THREElib.Group();
    for(let i=0;i<barCount;i++){
      const g = new THREElib.BoxGeometry(0.28,0.28,0.28);
      const m = new THREElib.MeshStandardMaterial({color:0x00c2ff});
      const mesh = new THREElib.Mesh(g,m);
      mesh.position.set(i*0.32 - (barCount*0.32)/2 + 1.6, 0.14, 0);
      barGroup.add(mesh); barsGroup.push(mesh);
    }
    scene.add(barGroup);

    const ground = new THREElib.Mesh(new THREElib.PlaneGeometry(20,20), new THREElib.MeshStandardMaterial({color:0x061018}));
    ground.rotation.x = -Math.PI/2; ground.position.y = -0.8; scene.add(ground);

    const controls = new THREElib.OrbitControls(camera, renderer.domElement); controls.enableDamping = true;

    function animate(){
      requestAnimationFrame(animate);
      cube.rotation.x += 0.004; cube.rotation.y += 0.006;
      for(let i=0;i<barsGroup.length;i++){
        const v = speedHistory[speedHistory.length - 1 - i] || 0;
        const h = Math.max(0.05, Math.min(6, (v/200)));
        barsGroup[i].scale.y = THREElib.MathUtils.lerp(barsGroup[i].scale.y || 0.05, h, 0.15);
        barsGroup[i].position.y = (barsGroup[i].scale.y)/2;
        const hue = Math.max(0, 0.6 - (v/2000));
        barsGroup[i].material.color.setHSL(hue, 0.7, 0.5);
      }
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', ()=>{
      const w = container.clientWidth; const h = container.clientHeight;
      renderer.setSize(w,h); camera.aspect = w/h; camera.updateProjectionMatrix();
    });

    window._threeInited = true;
    updateThreeVisual();
  }

  function updateThreeVisual(){
    if(!threeReady || !cube) return;
    const lastHeap = heapHistory[heapHistory.length-1] || 0;
    const t = Math.min(1, (lastHeap/1000));
    const col = new THREElib.Color().setHSL((1-t)*0.45, 0.8, 0.4);
    cube.material.color.copy(col);
  }

  /* ============================
     Speed & Ping helpers
     ============================ */
  $('pingBtn').addEventListener('click', async ()=>{
    setText('netRes','Pinging...');
    try{
      const t0 = performance.now(); await fetch('https://api.ipify.org?format=json', {cache:'no-store'}); const rtt = (performance.now()-t0).toFixed(1);
      setText('netRes', `RTT ~ ${rtt} ms`);
      const kbEst = Math.max(0, 1000 - Number(rtt)); window.__pushSpeed(kbEst);
    }catch(e){ setText('netRes','Ping gagal'); }
  });

  $('speedBtn').addEventListener('click', async ()=>{
    showOverlay('Speed test...');
    try{
      const url = 'https://eu.httpbin.org/stream-bytes/300000?seed=0';
      const t0 = performance.now();
      const r = await fetch(url);
      if(!r.body){ setText('netRes','Gagal (stream not supported)'); hideOverlay(); return; }
      const reader = r.body.getReader(); let rec=0;
      while(true){
        const {done,value} = await reader.read();
        if(done) break;
        rec += value.length;
      }
      const dur = (performance.now()-t0)/1000;
      const kb = rec/1024; const kbps = kb/dur;
      setText('netRes', `${kbps.toFixed(0)} KB/s • ${(kbps/1024).toFixed(2)} MB/s`);
      window.__pushSpeed(kbps);
    }catch(e){ setText('netRes','Gagal speed test (CORS/Blocked)'); }
    hideOverlay();
  });

  /* ============================
     Small init & preloads
     ============================ */
  // draw initial mosaic
  setTimeout(()=>{ try{ if(window._fpsChartInited){} else drawCanvasMosaic(); }catch(e){} }, 200);

  // eager but safe init to make UI responsive (optional)
  setTimeout(()=>{ init2DCharts().catch(()=>{}); /* don't force 3D until user opens tab */ }, 900);

  // expose simple push APIs
  window.HandiDevSnapshot = collectSnapshot;
  // __pushSpeed and __pushTF already defined above

  </script>
</body>
</html>
