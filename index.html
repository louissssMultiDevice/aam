<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Handi Dev • Device Insight — Ultra+ (Hologram)</title>
  <meta name="theme-color" content="#071018" />
  <style>
    :root{
      --bg:#071018; --card:#0f1720; --text:#dff8f6; --muted:#9fbfc8;
      --accent:#00ffc6; --accent-2:#00c2ff;
    }
    [data-theme='light']{--bg:#f6fbff;--card:#fff;--text:#032027;--muted:#4b6b74}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#071018);color:var(--text)}
    .wrap{max-width:1280px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001}
    h1{margin:0;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;padding:8px 10px;border-radius:8px;color:#001;font-weight:700;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin-top:16px}
    .card{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:84px}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .footer{margin:22px 0;color:var(--muted);font-size:13px}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;backdrop-filter:blur(4px);visibility:hidden;opacity:0;transition:all .18s}
    .overlay.show{visibility:visible;opacity:1}
    .loader{background:var(--card);padding:18px;border-radius:12px;display:flex;gap:12px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);animation:blink 1s infinite}
    @keyframes blink{50%{opacity:0.25;transform:scale(.8)}}
    .charts-section{margin-top:20px;padding-top:16px;border-top:1px dashed rgba(255,255,255,0.04)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
    .tab.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#001}
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
    .chart-card{background:var(--card);padding:12px;border-radius:8px;min-height:200px;border:1px solid rgba(255,255,255,0.03)}
    canvas{width:100%!important;height:220px!important}
    #three3d{width:100%;height:420px;border-radius:8px;display:block;background:#000;overflow:hidden}
    @media (max-width:920px){#three3d{height:320px}}
    .muted{color:var(--muted);font-size:12px}
    .tag{display:inline-block;background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:999px;font-size:12px}
    pre{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;overflow:auto}
    a {color:var(--accent-2)}
  </style>
</head>
<body data-theme="dark">
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo">HD+</div>
        <div>
          <h1>Handi Dev • Device Insight — Ultra+ (Hologram)</h1>
          <div class="subtitle">Detect lengkap • grafik 2D & 3D interaktif • hologram device</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="themeBtn">Theme</button>
        <button class="btn" id="copyAll">Copy All</button>
        <button class="btn" id="exportAllJSON">Export JSON</button>
        <button class="btn" id="toggleCharts">Open Charts</button>
      </div>
    </header>

    <!-- TOP: basics -->
    <div class="grid" id="infoGrid" style="margin-top:12px">
      <div class="card">
        <h3>Device & Browser</h3>
        <div class="mono" id="ua">—</div>
        <div class="small" id="device">—</div>
      </div>

      <div class="card">
        <h3>Network & IP</h3>
        <div class="mono v" id="ip">—</div>
        <div class="small">Status: <span id="online">—</span> • Downlink: <span id="downlink">—</span></div>
        <div style="margin-top:8px" class="row"><button class="btn" id="btn-ip">Refresh IP</button><button class="btn" id="pingBtn">Ping</button><button class="btn" id="speedBtn">Speed</button></div>
        <div class="small" id="netRes">—</div>
      </div>

      <div class="card">
        <h3>Camera & Microphone</h3>
        <div class="v" id="camInfo">—</div>
        <div class="small">Jumlah input & label (butuh permission)</div>
        <div style="margin-top:8px" class="row"><button class="btn" id="btn-getDevices">Detect Devices</button><button class="btn" id="btn-permMedia">Request Permission</button><button class="btn" id="btn-previewCam">Preview Camera</button></div>
        <div id="camPreview" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>Contacts & Gmail</h3>
        <div class="v" id="contactsInfo">Contacts API: —</div>
        <div class="small" id="gmailInfo">Gmail hint: —</div>
        <div style="margin-top:8px" class="row"><button class="btn" id="btn-checkContacts">Check Contact Picker</button><button class="btn" id="btn-pickContact">Pick Contact</button><button class="btn" id="btn-checkGmail">Check Gmail</button></div>
      </div>

      <div class="card">
        <h3>Battery</h3>
        <div class="v" id="battery-level">—</div>
        <div class="small" id="battery-status">—</div>
      </div>

      <div class="card">
        <h3>Security</h3>
        <div id="incognito" class="v">—</div>
        <div id="secureNotes" class="small">Proxy / VPN heuristic</div>
      </div>
    </div>

    <!-- MIDDLE: advanced -->
    <div class="grid" style="margin-top:18px">
      <div class="card">
        <h3>Deep Fingerprint</h3>
        <div class="mono v" id="fingerprint">—</div>
        <div class="small">Canvas • Audio • WebGL • Fonts • Timezone • UA</div>
        <div style="margin-top:8px" class="row"><button class="btn" id="runCanvas">Canvas FP</button><button class="btn" id="runAudio">Audio FP</button><button class="btn" id="runAllFP">All FP</button></div>
      </div>

      <div class="card">
        <h3>WebGL & GPU</h3>
        <div id="gpu" class="v">—</div>
        <div class="small">Shader precision: <span id="shaderPrec">—</span></div>
      </div>

      <div class="card">
        <h3>Font Detection</h3>
        <div id="fonts" class="v">—</div>
        <div class="small">Mendeteksi font populer</div>
      </div>

      <div class="card">
        <h3>AI Insight</h3>
        <div id="aiInsight" class="v">—</div>
        <div class="small">Heuristik otomatis berdasarkan data</div>
      </div>
    </div>

    <!-- BOTTOM: Charts section -->
    <div class="charts-section" id="chartsSection" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tabs" role="tablist">
          <div class="tab active" data-tab="2d">📊 Grafik 2D</div>
          <div class="tab" data-tab="3d">🌀 Grafik 3D</div>
        </div>
        <div class="row">
          <button class="btn" id="exportVisualPNG">Export Snapshot</button>
          <button class="btn" id="closeCharts">Close Charts</button>
        </div>
      </div>

      <!-- 2D -->
      <div id="tab-2d">
        <div class="chart-grid" style="margin-top:12px">
          <div class="chart-card">
            <h4>FPS & JS Heap</h4>
            <canvas id="fpsChart"></canvas>
            <div class="small">Line chart: FPS & Heap (MB).</div>
          </div>

          <div class="chart-card">
            <h4>Battery & Speed</h4>
            <canvas id="batteryNetChart"></canvas>
            <div class="small">Battery history & speed bars.</div>
          </div>

          <div class="chart-card">
            <h4>Acceleration (X/Y/Z)</h4>
            <canvas id="accelChart"></canvas>
            <div class="small">Accelerometer (radar).</div>
          </div>

          <div class="chart-card">
            <h4>Canvas Mosaic</h4>
            <canvas id="canvasMosaic" style="height:180px"></canvas>
            <div class="small">Visual fingerprint mosaic.</div>
          </div>

          <div class="chart-card">
            <h4>TF.js Inference Heatmap</h4>
            <canvas id="heatmapChart"></canvas>
            <div class="small">Micro-benchmark (ms).</div>
          </div>
        </div>
      </div>

    <div class="footer">Catatan: beberapa fitur memerlukan izin (kamera, microphone, contacts). Data tetap di client kecuali di-export.</div>
  </div>

  <div class="overlay" id="overlay"><div class="loader"><div class="dot"></div><div><div id="overlayTxt">Loading…</div><div class="small">Mohon tunggu</div></div></div></div>

  <!-- load Chart.js (UMD) and Three.js (non-module) dynamically inside script -->
  <script>
  // -------------------- Helpers --------------------
  const $ = id => document.getElementById(id);
  function pad(n){return String(n).padStart(2,'0')}
  function setText(id, txt){ const e=$(id); if(e) e.textContent = txt; }
  function showOverlay(txt='Loading…'){ $('overlay').classList.add('show'); $('overlayTxt').textContent = txt; }
  function hideOverlay(){ $('overlay').classList.remove('show'); }

  // theme toggle
  $('themeBtn').addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    document.documentElement.setAttribute('data-theme', cur==='light' ? 'dark' : 'light');
  });

  // copy/export
  function collectSnapshot(){
    return {
      ts: new Date().toISOString(),
      ua: navigator.userAgent,
      platform: navigator.platform,
      cores: navigator.hardwareConcurrency || null,
      ram: navigator.deviceMemory || null,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      fingerprint: $('fingerprint')?.textContent || null
    };
  }
  $('copyAll').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(JSON.stringify(collectSnapshot(),null,2)); alert('Disalin ke clipboard') }catch(e){alert('Gagal: '+e.message)}});
  $('exportAllJSON').addEventListener('click', ()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(collectSnapshot(),null,2)],{type:'application/json'})); a.download='handidev-ultra-plus.json'; a.click(); });

  // charts show/hide
  $('toggleCharts').addEventListener('click', ()=>{ $('chartsSection').style.display='block'; document.querySelector('.tab[data-tab="2d"]').click(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); });
  $('closeCharts').addEventListener('click', ()=>{ $('chartsSection').style.display='none'; });

  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', async ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.getAttribute('data-tab');
      if(tab === '2d'){ $('tab-2d').style.display=''; $('tab-3d').style.display='none'; if(!window._chartsInited) init2DCharts().catch(()=>{}); }
      else { $('tab-2d').style.display='none'; $('tab-3d').style.display=''; if(!window._threeInited) initThree().catch(()=>{}); }
    });
  });

  // -------------------- Basic fills --------------------
  setText('ua', navigator.userAgent);
  setText('device', navigator.platform || '—');
  setText('cores', navigator.hardwareConcurrency || '—');
  setText('ram', navigator.deviceMemory || '—');

  // battery
  (async function batteryInit(){
    try{
      if('getBattery' in navigator){
        const b = await navigator.getBattery();
        function paint(){ setText('battery-level', Math.round(b.level*100)+'%'); setText('battery-status', b.charging? 'Charging':'Discharging'); }
        ['levelchange','chargingchange'].forEach(e=>b.addEventListener(e,paint));
        paint();
      } else { setText('battery-level','—'); setText('battery-status','Not supported'); }
    }catch(e){ setText('battery-level','—'); setText('battery-status','Error') }
  })();

  // IP
  async function fetchIP(){ try{ showOverlay('Mengambil IP...'); const r=await fetch('https://api.ipify.org?format=json'); const j=await r.json(); setText('ip', j.ip || '—'); }catch(e){ setText('ip','Gagal ambil IP') } finally{ hideOverlay(); } }
  $('btn-ip').addEventListener('click', fetchIP); fetchIP();

  // connection paint
  function paintNet(){ const c=navigator.connection||navigator.mozConnection||navigator.webkitConnection; setText('online', navigator.onLine? 'online' : 'offline'); setText('downlink', c?.downlink ?? '—'); }
  paintNet(); (navigator.connection||{}).addEventListener?.('change', paintNet); window.addEventListener('online', paintNet); window.addEventListener('offline', paintNet);

  // heap sampling
  async function paintHeap(){ try{ if(performance?.memory) setText('heap', (performance.memory.usedJSHeapSize/1024/1024).toFixed(1) + ' MB'); else setText('heap','N/A') }catch(e){ setText('heap','—') } }
  setInterval(paintHeap,1500); paintHeap();

  // sensors devicemotion
  const accelHistory = [];
  function pushAccelSample(sample){ accelHistory.push(sample); if(accelHistory.length>60) accelHistory.shift(); }
  if('DeviceMotionEvent' in window){
    window.addEventListener('devicemotion', e=>{
      const a = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
      setText('sensorVal', `X:${(a.x||0).toFixed(2)} Y:${(a.y||0).toFixed(2)} Z:${(a.z||0).toFixed(2)}`);
      pushAccelSample({x:a.x||0,y:a.y||0,z:a.z||0});
    });
  }

  // incognito check (best-effort)
  (async function incognitoCheck(){
    try{
      let fs = window.RequestFileSystem || window.webkitRequestFileSystem;
      if(!fs){
        const key='handi_test';
        try{ localStorage.setItem(key,'1'); localStorage.removeItem(key); setText('incognito','Normal (localStorage OK)'); return; }
        catch(err){ setText('incognito','Private/Restricted (localStorage failure)'); return; }
      }
      fs(window.TEMPORARY,100, ()=>setText('incognito','Normal'), ()=>setText('incognito','Incognito/Private'));
    }catch(e){ setText('incognito','Tidak pasti') }
  })();

  // ai insight
  function aiAnalysis(){ const cores=navigator.hardwareConcurrency||2; const ram=navigator.deviceMemory||2; const heap=(performance?.memory?.usedJSHeapSize||0)/1024/1024; const notes=[]; if(ram<2) notes.push('RAM terbatas'); else if(ram>=8) notes.push('RAM besar'); if(cores<=2) notes.push('CPU sedikit'); else notes.push('CPU cukup'); if(heap>300) notes.push('Heap tinggi'); setText('aiInsight', notes.join(' • ') || 'Normal'); }
  aiAnalysis(); setInterval(aiAnalysis,10000);

  // -------------------- Fingerprint (canvas/audio/webgl/fonts) --------------------
  function canvasFingerprint(){
    try{
      const c=document.createElement('canvas'); c.width=512; c.height=200;
      const ctx=c.getContext('2d');
      ctx.textBaseline='top'; ctx.font='16px Arial';
      ctx.fillStyle='#f60'; ctx.fillRect(125,1,62,20);
      ctx.fillStyle='#069'; ctx.fillText('Handi Dev — Canvas FP',2,15);
      ctx.fillStyle='rgba(102,200,0,0.7)'; ctx.fillText('✓ 測試 — 𝓕𝓟',4,45); 
      return c.toDataURL().slice(-120);
    }catch(e){ return null; }
  }
  function getWebGLInfo(){
    try{
      const c=document.createElement('canvas'); const gl=c.getContext('webgl') || c.getContext('experimental-webgl'); if(!gl) return null;
      const dbg=gl.getExtension('WEBGL_debug_renderer_info'); const vendor=dbg? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR); const renderer = dbg? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER); return {vendor, renderer};
    }catch(e){ return null; }
  }
  async function audioFingerprint(){
    try{
      const ac=new (window.AudioContext||window.webkitAudioContext)(); const osc=ac.createOscillator(); const node=ac.createAnalyser(); osc.type='sine'; osc.frequency.value = 440 + (Math.random()*100); osc.connect(node); node.connect(ac.destination); osc.start();
      const arr=new Uint8Array(node.frequencyBinCount); node.getByteFrequencyData(arr); osc.stop(); await ac.close?.();
      return Array.from(arr.slice(0,20)).join(',').slice(0,80);
    }catch(e){ return null;}
  }
  function detectFont(font){ try{ const base=document.createElement('span'); base.style.fontFamily='monospace'; base.style.fontSize='72px'; base.innerText='mmmmmmmmmlli'; base.style.position='absolute'; base.style.left='-9999px'; document.body.appendChild(base); const defaultWidth = base.offsetWidth; base.style.fontFamily = font + ', monospace'; const matched = base.offsetWidth !== defaultWidth; base.remove(); return matched; }catch(e){return false} }
  function detectFontsList(){ const fonts=['Arial','Roboto','Segoe UI','Times New Roman','Courier New','Noto Sans','Inter']; return fonts.filter(f=>detectFont(f)); }

  $('runCanvas').addEventListener('click', ()=>{
    const c = canvasFingerprint(); setText('fingerprint', c ? c.slice(0,28) : 'Gagal');
    try{ const gl = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl'); const highp = gl && (gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.HIGH_FLOAT).precision>0); setText('shaderPrec', highp? 'highp':'mediump/lowp'); }catch(e){ setText('shaderPrec','—') }
  });
  $('runAudio').addEventListener('click', async ()=>{ setText('audioFP','Running...'); const a = await audioFingerprint(); setText('audioFP', a || 'Gagal'); });
  $('runAllFP').addEventListener('click', async ()=>{
    setText('fingerprint','Running...');
    const webgl = getWebGLInfo(); const canvas = canvasFingerprint(); const audio = await audioFingerprint(); const fonts = detectFontsList();
    const base = navigator.userAgent + '|' + navigator.language + '|' + JSON.stringify(webgl) + '|' + (canvas||'') + '|' + (audio||'') + '|' + fonts.join(',');
    const h = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(base)); const hex = Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
    setText('fingerprint', hex.slice(0,28)); setText('fonts', fonts.join(', ') || '—'); setText('canvasHash', canvas || '—'); setText('audioFP', audio || '—');
  });

  // webgl summary
  (function setWebGLSummary(){ const w=getWebGLInfo(); if(w) setText('gpu', `${w.renderer||'—'} (${w.vendor||'—'})`); else setText('gpu','Not available'); try{ const glTest = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl'); if(glTest){ const p = glTest.getShaderPrecisionFormat(glTest.FRAGMENT_SHADER, glTest.HIGH_FLOAT); setText('shaderPrec', (p && p.precision>0) ? 'highp' : 'mediump/lowp'); } }catch(e){} })();

  // webauthn/webxr checks
  (async function checkWebAPIs(){ setText('webauthn', !!window.PublicKeyCredential ? 'Supported' : 'Not supported'); try{ if(navigator.xr && navigator.xr.isSessionSupported){ const sup = await navigator.xr.isSessionSupported('immersive-vr'); setText('webxr', sup ? 'VR Supported' : 'No VR'); } else setText('webxr','No WebXR') }catch(e){ setText('webxr','Error') } })();

  // -------------------- Camera / Contacts / Gmail hint --------------------
  async function detectMediaDevices(){
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices){ setText('camInfo','MediaDevices not supported'); return null; }
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput'); const mics = devices.filter(d=>d.kind==='audioinput');
      const labelsVisible = cams.concat(mics).some(d=>d.label && d.label.length>0);
      setText('camInfo', `Cameras: ${cams.length}, Mics: ${mics.length} • labels: ${labelsVisible? 'visible':'hidden'}`);
      return {cams,mics,labelsVisible};
    }catch(e){ setText('camInfo','Detect devices failed'); return null; }
  }
  $('btn-getDevices').addEventListener('click', detectMediaDevices);
  $('btn-permMedia').addEventListener('click', async ()=>{
    try{ showOverlay('Requesting camera/mic permission...'); const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true}); await detectMediaDevices(); stream.getTracks().forEach(t=>t.stop()); }catch(e){ alert('Permission denied or error: ' + (e.message||e)); } finally { hideOverlay(); }
  });
  $('btn-previewCam').addEventListener('click', async ()=>{
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return alert('getUserMedia not supported');
      showOverlay('Opening camera preview...');
      const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
      const wrap = $('camPreview'); wrap.innerHTML = '';
      const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.muted=true; v.srcObject=stream; v.style.width='220px'; v.style.borderRadius='8px'; wrap.appendChild(v);
      setTimeout(()=>{ stream.getTracks().forEach(t=>t.stop()); wrap.innerHTML=''; hideOverlay(); }, 12000);
    }catch(e){ hideOverlay(); alert('Preview failed: '+(e.message||e)); }
  });

  $('btn-checkContacts').addEventListener('click', ()=>{ if('contacts' in navigator || 'ContactsManager' in window) setText('contactsInfo','Contact Picker API supported'); else setText('contactsInfo','Contact Picker NOT supported'); });

  $('btn-pickContact').addEventListener('click', async ()=>{
    if(!('contacts' in navigator) && !('ContactsManager' in window)){ alert('Contact Picker API not available'); return; }
    try{
      const props=['name','tel','email','icon'];
      const contacts = await navigator.contacts.select(props, {multiple:false});
      if(contacts && contacts.length>0){ const c=contacts[0]; setText('contactsInfo', `Picked: ${ (c.name && c.name[0]) || (c.email && c.email[0]) || 'Contact' }`); } else setText('contactsInfo','No contact selected');
    }catch(e){ setText('contactsInfo','Contact pick canceled/blocked'); }
  });

  $('btn-checkGmail').addEventListener('click', async ()=>{
    setText('gmailInfo','Checking...');
    if(!('credentials' in navigator)){ setText('gmailInfo','Credential API not supported'); return; }
    try{
      // federated silent get may be blocked; this is a hint only
      const cred = await navigator.credentials.get?.({federated:{providers:['https://accounts.google.com']}, mediation:'silent'});
      if(cred) setText('gmailInfo','Google federated credential available (hint)'); else setText('gmailInfo','No silent Google credential (or not allowed)');
    }catch(e){ setText('gmailInfo','Credential API exists but silent get failed/blocked'); }
  });

  // -------------------- Speed / Ping --------------------
  $('pingBtn').addEventListener('click', async ()=>{
    setText('netRes','Pinging...');
    try{ const t0=performance.now(); await fetch('https://api.ipify.org?format=json', {cache:'no-store'}); const rtt=(performance.now()-t0).toFixed(1); setText('netRes', `RTT ~ ${rtt} ms`); const kbEst = Math.max(0, 1000 - Number(rtt)); window.__pushSpeed?.(kbEst); }catch(e){ setText('netRes','Ping gagal') }
  });

  $('speedBtn').addEventListener('click', async ()=>{
    showOverlay('Speed test...');
    try{
      const url='https://eu.httpbin.org/stream-bytes/300000?seed=0';
      const t0=performance.now(); const r=await fetch(url);
      if(!r.body){ setText('netRes','Gagal (stream not supported)'); hideOverlay(); return; }
      const reader = r.body.getReader(); let rec=0;
      while(true){ const {done,value} = await reader.read(); if(done) break; rec += value.length; }
      const dur=(performance.now()-t0)/1000; const kb=rec/1024; const kbps = kb/dur;
      setText('netRes', `${kbps.toFixed(0)} KB/s • ${(kbps/1024).toFixed(2)} MB/s`);
      window.__pushSpeed?.(kbps);
    }catch(e){ setText('netRes','Gagal speed test (CORS/Blocked)') } finally{ hideOverlay(); }
  });

  // -------------------- Charts 2D (Chart.js lazy) --------------------
  const maxPoints = 60;
  const fpsHistory = Array(maxPoints).fill(null);
  const heapHistory = Array(maxPoints).fill(null);
  const batteryHistory = Array(maxPoints).fill(null);
  const speedHistory = Array(maxPoints).fill(0);
  const tfHeat = Array(maxPoints).fill(null);
  let ChartJS = null, fpsChart=null, batteryNetChart=null, accelChart=null, heatmapChart=null, canvasCtx=null;
  function pushLimited(arr, v){ arr.push(v); if(arr.length>maxPoints) arr.shift(); }

  // FPS sampler
  let frames = 0, last = performance.now();
  function fpsSampler(now){
    frames++;
    if(now - last >= 1000){ pushLimited(fpsHistory, frames); frames=0; last=now; try{ if(performance?.memory) pushLimited(heapHistory, performance.memory.usedJSHeapSize/1024/1024); else pushLimited(heapHistory, null); }catch(e){ pushLimited(heapHistory, null); } update2DCharts(); updateThreeVisual(); }
    requestAnimationFrame(fpsSampler);
  }
  requestAnimationFrame(fpsSampler);

  // battery watch
  (async function batteryWatch(){ try{ if('getBattery' in navigator){ const b = await navigator.getBattery(); function p(){ pushLimited(batteryHistory, Math.round(b.level*100)); update2DCharts(); } ['levelchange','chargingchange'].forEach(e=>b.addEventListener(e,p)); p(); } }catch(e){} })();

  window.__pushSpeed = function(kb){ pushLimited(speedHistory, kb); update2DCharts(); };
  window.__pushTF = function(ms){ pushLimited(tfHeat, ms); update2DCharts(); };

  async function ensureChartJs(){
    if(window.Chart) return window.Chart;
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    return window.Chart;
  }

  async function init2DCharts(){
    if(window._chartsInited) return;
    ChartJS = await ensureChartJs();
    // FPS chart
    const ctxF = document.getElementById('fpsChart').getContext('2d');
    fpsChart = new ChartJS(ctxF, { type:'line', data:{ labels:Array(maxPoints).fill(''), datasets:[ {label:'FPS', data: fpsHistory, borderColor:'#00ffc6', tension:0.25, fill:false}, {label:'Heap MB', data: heapHistory, borderColor:'#00c2ff', tension:0.25, fill:false, yAxisID:'y1'} ] }, options:{ animation:false, scales:{ y:{beginAtZero:true}, y1:{position:'right', beginAtZero:true} } } });

    // Battery & Speed
    const ctxB = document.getElementById('batteryNetChart').getContext('2d');
    batteryNetChart = new ChartJS(ctxB, { data:{ labels:Array(maxPoints).fill(''), datasets:[ {type:'line', label:'Battery %', data: batteryHistory, borderColor:'#6ef37b', fill:false, yAxisID:'batt'}, {type:'bar', label:'Speed KB/s', data: speedHistory, backgroundColor:'#00c2ff', yAxisID:'speed'} ] }, options:{ animation:false, scales:{ batt:{type:'linear', position:'left', beginAtZero:true, max:100}, speed:{type:'linear', position:'right', beginAtZero:true} } } });

    // Accel radar
    const ctxA = document.getElementById('accelChart').getContext('2d');
    accelChart = new ChartJS(ctxA, { type:'radar', data:{ labels:['X','Y','Z'], datasets:[{label:'Accel', data:[0,0,0], backgroundColor:'rgba(0,194,255,0.12)', borderColor:'#00c2ff'}] }, options:{ animation:false, scales:{ r:{ beginAtZero:true } } } });

    // mosaic
    const c = document.getElementById('canvasMosaic'); canvasCtx = c.getContext('2d'); drawCanvasMosaic();

    // heatmap
    const ctxH = document.getElementById('heatmapChart').getContext('2d');
    heatmapChart = new ChartJS(ctxH, { type:'bar', data:{ labels:Array(maxPoints).fill(''), datasets:[{label:'TF Inference (ms)', data: tfHeat, backgroundColor:'#ffb86b'}] }, options:{animation:false, scales:{y:{beginAtZero:true}}} });

    window._chartsInited = true;
    update2DCharts();
  }

  function drawCanvasMosaic(){
    try{
      const canvas = document.getElementById('canvasMosaic'); const ctx = canvasCtx;
      const w = canvas.width = canvas.clientWidth * devicePixelRatio; const h = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      const tmp = document.createElement('canvas'); tmp.width=240; tmp.height=90;
      const t=tmp.getContext('2d'); t.fillStyle='#071018'; t.fillRect(0,0,tmp.width,tmp.height); t.fillStyle='#00ffc6'; t.font='22px Inter, Arial'; t.fillText('Handi Dev',14,40);
      const img=new Image(); img.onload = ()=>{ const cols=8, rows=3, cw=w/cols, ch=h/rows; for(let y=0;y<rows;y++) for(let x=0;x<cols;x++) ctx.drawImage(img, x*cw, y*ch, cw, ch); }; img.src=tmp.toDataURL();
    }catch(e){}
  }

  function update2DCharts(){
    if(fpsChart){ fpsChart.data.datasets[0].data = fpsHistory.slice(); fpsChart.data.datasets[1].data = heapHistory.slice(); fpsChart.update('none'); }
    if(batteryNetChart){ batteryNetChart.data.datasets[0].data = batteryHistory.slice(); batteryNetChart.data.datasets[1].data = speedHistory.slice(); batteryNetChart.update('none'); }
    if(heatmapChart){ heatmapChart.data.datasets[0].data = tfHeat.slice(); heatmapChart.update('none'); }
    if(accelChart){ const last = accelHistory[accelHistory.length-1] || {x:0,y:0,z:0}; accelChart.data.datasets[0].data = [Math.abs(last.x), Math.abs(last.y), Math.abs(last.z)]; accelChart.update('none'); }
  }

  // -------------------- THREE.JS 3D + Hologram (lazy load) --------------------
  let threeReady = false;
  async function initThree(){
    if(threeReady) return;
    // load three + OrbitControls
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/examples/js/controls/OrbitControls.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    hideOverlay();
    const THREE = window.THREE;
    threeReady = true;
    // container
    const container = $('three3d');
    container.innerHTML = '';
    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:false});
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x071018);

    const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 2000);
    camera.position.set(0, 2.0, 6);

    // lights
    const pl = new THREE.PointLight(0xffffff, 1.0);
    pl.position.set(5, 6, 5); scene.add(pl);
    scene.add(new THREE.AmbientLight(0x404040));

    // ground subtle
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshStandardMaterial({color:0x061018}));
    ground.rotation.x = -Math.PI/2; ground.position.y = -1.0; scene.add(ground);

    // indicator cube
    const indicatorCube = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), new THREE.MeshStandardMaterial({color:0x00ffc6, metalness:0.2, roughness:0.4}));
    indicatorCube.position.set(-2.6, 0.2, 0); scene.add(indicatorCube);

    // Handi Dev box with canvas textures on faces
    function createHandiBox(){
      const size = 1.2;
      const geo = new THREE.BoxGeometry(size,size,size);
      const mats = [];
      const faces = ['Handi','Dev','HD+','Ultra','Insight',''];
      for(let i=0;i<6;i++){
        const c = document.createElement('canvas'); c.width=512; c.height=512;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#001316'; ctx.fillRect(0,0,c.width,c.height);
        ctx.fillStyle = '#00ffc6'; ctx.fillRect(0,0,c.width,120);
        ctx.fillStyle = '#001'; ctx.font='bold 72px Inter, Arial'; ctx.fillText(faces[i]||'',40,220);
        ctx.fillStyle = '#00c2ff'; ctx.font='18px Inter, Arial'; ctx.fillText('Handi Dev',40,260);
        const tex = new THREE.CanvasTexture(c);
        mats.push(new THREE.MeshStandardMaterial({map:tex}));
      }
      const mesh = new THREE.Mesh(geo, mats);
      mesh.castShadow = true;
      mesh.position.set(0,0.4,0);
      return mesh;
    }
    const handiBox = createHandiBox();
    handiBox.position.set(-0.6,0.4,0);
    scene.add(handiBox);

    // Speed bars
    const barsGroup = new THREE.Group(); const bars = [];
    const barCount = 16;
    for(let i=0;i<barCount;i++){
      const g = new THREE.BoxGeometry(0.28,0.28,0.28);
      const m = new THREE.MeshStandardMaterial({color:0x00c2ff, metalness:0.2, roughness:0.5});
      const mesh = new THREE.Mesh(g,m);
      mesh.position.set(i*0.32 - (barCount*0.32)/2 + 2.4, 0.14, 0);
      mesh.scale.y = 0.05;
      barsGroup.add(mesh); bars.push(mesh);
    }
    scene.add(barsGroup);

    // Hologram box (glass)
    const holoBoxGeo = new THREE.BoxGeometry(3.6,2.2,3.6);
    const holoMat = new THREE.MeshPhysicalMaterial({color:0x00ffe0, metalness:0.0, roughness:0.1, transparent:true, opacity:0.08, transmission:0.5, side: THREE.BackSide});
    const holoShell = new THREE.Mesh(holoBoxGeo, holoMat); holoShell.position.set(0,0.6,0); scene.add(holoShell);

    // Hologram devices group
    const holoGroup = new THREE.Group(); holoGroup.position.set(0,0.6,0); scene.add(holoGroup);

    // helper to create stylized hologram device (flat)
    function makeHoloDevice(color, w, h, d){
      const geom = new THREE.BoxGeometry(w,h,d);
      const mat = new THREE.MeshStandardMaterial({color: color, emissive: color, emissiveIntensity: 0.7, transparent:true, opacity:0.6, metalness:0.1, roughness:0.3});
      const mesh = new THREE.Mesh(geom, mat);
      return mesh;
    }

    const phone = makeHoloDevice(0x00ffe0, 0.6, 1.0, 0.06); phone.position.set(-1.0, 0.0, 0.0); holoGroup.add(phone);
    const laptop = makeHoloDevice(0x00c2ff, 1.2, 0.7, 0.08); laptop.position.set(1.0, -0.05, 0.1); laptop.rotation.x = -0.2; holoGroup.add(laptop);
    const desktop = makeHoloDevice(0xff66ff, 0.9, 0.8, 0.12); desktop.position.set(0.0, 0.05, -1.0); holoGroup.add(desktop);

    // add subtle neon ring under holo devices
    const ringGeo = new THREE.RingGeometry(0.5, 1.2, 64);
    const ringMat = new THREE.MeshBasicMaterial({color:0x00ffe0, side:THREE.DoubleSide, transparent:true, opacity:0.08});
    const ring = new THREE.Mesh(ringGeo, ringMat); ring.rotation.x = -Math.PI/2; ring.position.y = -0.2; holoGroup.add(ring);

    // orbit controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.06;
    controls.target.set(0, 0.3, 0);

    // animation loop
    function updateBarsFromSpeed(){
      for(let i=0;i<bars.length;i++){
        const idx = speedHistory.length - 1 - i;
        const v = (idx>=0) ? (speedHistory[idx] || 0) : 0;
        const scaled = Math.max(0.05, Math.min(6, v/120));
        bars[i].scale.y = THREE.MathUtils.lerp(bars[i].scale.y || 0.05, scaled, 0.08);
        bars[i].position.y = (bars[i].scale.y)/2;
        const hue = Math.max(0, 0.6 - (v/2000));
        bars[i].material.color.setHSL(hue, 0.7, 0.5);
      }
    }

    let lastFrameTime = performance.now();
    function animate(){
      requestAnimationFrame(animate);
      const now = performance.now();
      const dt = (now - lastFrameTime)/1000;
      lastFrameTime = now;

      // rotate & float handiBox
      handiBox.rotation.y += 0.6 * dt;
      handiBox.position.y = 0.4 + Math.sin(now/600)*0.05;

      // indicator cube reacts to FPS/heap
      const fpsNow = fpsHistory[fpsHistory.length-1] || 30;
      const scale = 1 + (fpsNow/80);
      indicatorCube.scale.lerp(new THREE.Vector3(scale,scale,scale), 0.06);
      // color by heap
      const lastHeap = heapHistory[heapHistory.length-1] || 0;
      const t = Math.min(1, lastHeap/600);
      const col = new THREE.Color().setHSL((1-t)*0.45, 0.8, 0.4);
      indicatorCube.material.color.lerp(col, 0.06);

      // holoGroup rotation + floating of each device
      holoGroup.rotation.y += 0.25 * dt;
      const tS = now/600;
      phone.position.y = Math.sin(tS)*0.08;
      laptop.position.y = Math.sin(tS + 0.9)*0.06;
      desktop.position.y = Math.sin(tS + 1.6)*0.07;

      // pulse emissive intensity for hologram
      [phone,laptop,desktop].forEach((m, i) => {
        const s = 0.6 + 0.4*Math.sin(tS*2 + i);
        m.material.emissiveIntensity = THREE.MathUtils.lerp(m.material.emissiveIntensity || 0.7, s, 0.06);
      });

      updateBarsFromSpeed();
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', ()=>{ const w = container.clientWidth, h = container.clientHeight; renderer.setSize(w,h); camera.aspect = w/h; camera.updateProjectionMatrix(); });
    window._threeInited = true;
    // store refs for update function
    window._three_scene = { scene, camera, renderer };
  }

  function updateThreeVisual(){
    // visuals update handled inside three animation loop, so nothing needed here.
  }

  // auto-init charts & 3D on demand (preload a bit)
  setTimeout(()=>{ init2DCharts().catch(()=>{}); initThree().catch(()=>{}); }, 900);

  // export snapshot (chart canvas)
  $('exportVisualPNG').addEventListener('click', ()=>{
    const c = document.querySelector('#fpsChart') || document.querySelector('#batteryNetChart');
    if(c && c.toDataURL){ const a=document.createElement('a'); a.href = c.toDataURL('image/png'); a.download='handidev-chart.png'; a.click(); }
    else alert('Chart belum siap atau tidak bisa diexport.');
  });

  // small initial mosaic
  setTimeout(()=>{ try{ drawCanvasMosaic(); }catch(e){} }, 400);

  </script>
</body>
</html>
