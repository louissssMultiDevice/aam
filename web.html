<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Handi Dev • Device Insight — Ultra+ Hologram</title>
<meta name="theme-color" content="#071018"/>
<style>
:root{
  --bg:#071018; --card:#0f1720; --text:#dff8f6; --muted:#9fbfc8;
  --accent:#00ffc6; --accent-2:#00c2ff;
}
[data-theme='light']{
  --bg:#f6fbff; --card:#fff; --text:#032027; --muted:#4b6b74;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#071018);color:var(--text)}
.wrap{max-width:1280px;margin:18px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center;position:relative}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001;box-shadow:0 0 10px var(--accent)}
h1{margin:0;font-size:18px}
.subtitle{color:var(--muted);font-size:13px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;padding:8px 12px;border-radius:8px;color:#001;font-weight:700;cursor:pointer;transition:all .2s}
.btn:hover{transform:scale(1.05)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin-top:16px}
.card{background:var(--card);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-height:90px;transition:all .3s;position:relative;overflow:hidden}
.card:hover{box-shadow:0 0 12px var(--accent)}
.small{font-size:12px;color:var(--muted);margin-top:6px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
.row{display:flex;gap:8px;flex-wrap:wrap}
.footer{margin:22px 0;color:var(--muted);font-size:13px;text-align:center}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;backdrop-filter:blur(4px);visibility:hidden;opacity:0;transition:all .18s}
.overlay.show{visibility:visible;opacity:1}
.loader{background:var(--card);padding:18px;border-radius:12px;display:flex;gap:12px;align-items:center;box-shadow:0 0 10px var(--accent)}
.dot{width:10px;height:10px;border-radius:50%;background:var(--accent);animation:blink 1s infinite}
@keyframes blink{50%{opacity:0.25;transform:scale(.8)}}
.charts-section{margin-top:20px;padding-top:16px;border-top:1px dashed rgba(255,255,255,0.04)}
.tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;transition:all .2s}
.tab.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#001;box-shadow:0 0 8px var(--accent)}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
.chart-card{background:var(--card);padding:12px;border-radius:8px;min-height:200px;border:1px solid rgba(255,255,255,0.03);transition:all .3s}
canvas{width:100%!important;height:220px!important}
#three3d{width:100%;height:420px;border-radius:12px;display:block;background:#000;overflow:hidden}
@media (max-width:920px){#three3d{height:320px}}
.muted{color:var(--muted);font-size:12px}
.tag{display:inline-block;background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:999px;font-size:12px}
pre{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;overflow:auto}
a{color:var(--accent-2);text-decoration:none}
a:hover{text-decoration:underline}
#clock{position:absolute;top:0;right:0;font-size:14px;color:var(--accent);font-weight:700;margin:6px}
#calendar{margin-top:6px;font-size:12px;color:var(--accent-2);display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-start}
.flag{width:24px;height:16px;background-size:cover;display:inline-block;transform-origin:center;animation:wave 2s infinite alternate}
@keyframes wave{0%{transform:rotate(0deg)}100%{transform:rotate(12deg)}}
</style>
</head>
<body data-theme="dark">
<div class="wrap" id="app">
<header>
  <div class="brand">
    <div class="logo">HD+</div>
    <div>
      <h1>Handi Dev • Device Insight — Ultra+ (Hologram)</h1>
      <div class="subtitle">Detect lengkap • grafik 2D & 3D interaktif • hologram device</div>
      <div id="clock"></div>
      <div id="calendar"></div>
    </div>
  </div>
  <div class="controls">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="copyAll">Copy All</button>
    <button class="btn" id="exportAllJSON">Export JSON</button>
    <button class="btn" id="toggleCharts">Open Charts</button>
  </div>
</header>

<!-- GRID INFO -->
<div class="grid" id="infoGrid" style="margin-top:12px">
  <!-- Device & Browser -->
  <div class="card">
    <h3>Device & Browser</h3>
    <div class="mono" id="ua">—</div>
    <div class="small" id="device">—</div>
  </div>
  <!-- Network & IP -->
  <div class="card">
    <h3>Network & IP</h3>
    <div class="mono v" id="ip">—</div>
    <div class="small">Status: <span id="online">—</span> • Downlink: <span id="downlink">—</span></div>
    <div style="margin-top:8px" class="row">
      <button class="btn" id="btn-ip">Refresh IP</button>
      <button class="btn" id="pingBtn">Ping</button>
      <button class="btn" id="speedBtn">Speed</button>
    </div>
    <div class="small" id="netRes">—</div>
  </div>
  <!-- Camera & Microphone -->
  <div class="card">
    <h3>Camera & Microphone</h3>
    <div class="v" id="camInfo">—</div>
    <div class="small">Jumlah input & label (butuh permission)</div>
    <div style="margin-top:8px" class="row">
      <button class="btn" id="btn-getDevices">Detect Devices</button>
      <button class="btn" id="btn-permMedia">Request Permission</button>
      <button class="btn" id="btn-previewCam">Preview Camera</button>
    </div>
    <div id="camPreview" style="margin-top:8px"></div>
  </div>
  <!-- Contacts & Gmail -->
  <div class="card">
    <h3>Contacts & Gmail</h3>
    <div class="v" id="contactsInfo">Contacts API: —</div>
    <div class="small" id="gmailInfo">Gmail hint: —</div>
    <div style="margin-top:8px" class="row">
      <button class="btn" id="btn-checkContacts">Check Contact Picker</button>
      <button class="btn" id="btn-pickContact">Pick Contact</button>
      <button class="btn" id="btn-checkGmail">Check Gmail</button>
    </div>
  </div>
  <!-- Detect Nama Kontak -->
  <div class="card">
    <h3>Detect Nama Kontak</h3>
    <div id="detectedName">Nama: —</div>
    <button class="btn" id="btn-detectName">Pilih Kontak</button>
  </div>
</div>

<!-- Overlay Loader -->
<div class="overlay" id="overlay">
  <div class="loader">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <span id="overlayTxt">Loading…</span>
  </div>
</div>

<!-- Section Charts -->
<div class="charts-section" id="chartsSection" style="display:none">
  <div class="tabs">
    <div class="tab active" data-tab="2d">2D Charts</div>
    <div class="tab" data-tab="3d">3D Hologram</div>
    <button class="btn" id="closeCharts">Close</button>
    <button class="btn" id="exportVisualPNG">Export PNG</button>
  </div>
  <div id="tab-2d" class="chart-grid">
    <div class="chart-card"><canvas id="fpsChart"></canvas></div>
    <div class="chart-card"><canvas id="batteryNetChart"></canvas></div>
    <div class="chart-card"><canvas id="accelChart"></canvas></div>
    <div class="chart-card"><canvas id="heatmapChart"></canvas></div>
    <div class="chart-card"><canvas id="canvasMosaic"></canvas></div>
  </div>
  <div id="tab-3d" style="display:none">
    <div id="three3d"></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
function pad(n){return String(n).padStart(2,'0')}
function setText(id, txt){ const e=$(id); if(e) e.textContent = txt; }
function showOverlay(txt='Loading…'){ $('overlay').classList.add('show'); $('overlayTxt').textContent = txt; }
function hideOverlay(){ $('overlay').classList.remove('show'); }

// theme toggle
$('themeBtn').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', cur==='light' ? 'dark' : 'light');
});

// copy/export
function collectSnapshot(){
  return {
    ts: new Date().toISOString(),
    ua: navigator.userAgent,
    platform: navigator.platform,
    cores: navigator.hardwareConcurrency || null,
    ram: navigator.deviceMemory || null,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    fingerprint: $('fingerprint')?.textContent || null
  };
}
$('copyAll').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(JSON.stringify(collectSnapshot(),null,2));
    alert('Disalin ke clipboard');
  }catch(e){alert('Gagal: '+e.message)}
});
$('exportAllJSON').addEventListener('click', ()=>{
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(collectSnapshot(),null,2)],{type:'application/json'}));
  a.download='handidev-ultra-plus.json'; a.click();
});

// charts show/hide
$('toggleCharts').addEventListener('click', ()=>{
  $('chartsSection').style.display='block';
  document.querySelector('.tab[data-tab="2d"]').click();
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
});
$('closeCharts').addEventListener('click', ()=>{
  $('chartsSection').style.display='none';
});

// tabs switching
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', async ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.getAttribute('data-tab');
    if(tab === '2d'){
      $('tab-2d').style.display='';
      $('tab-3d').style.display='none';
      if(!window._chartsInited) init2DCharts().catch(()=>{});
    }
    else {
      $('tab-2d').style.display='none';
      $('tab-3d').style.display='';
      if(!window._threeInited) initThree().catch(()=>{});
    }
  });
});

// ---- Contact Picker (Nama Kontak) ----
$('btn-detectName').addEventListener('click', async ()=>{
  if(!('contacts' in navigator) && !('ContactsManager' in window)){
    alert('Contact Picker API tidak tersedia di browser ini');
    return;
  }
  try{
    const props = ['name','tel'];
    const contacts = await navigator.contacts.select(props,{multiple:false});
    if(contacts && contacts.length>0){
      const c = contacts[0];
      const name = (c.name && c.name[0]) || 'Tidak diketahui';
      const tel = (c.tel && c.tel[0]) || 'Tidak diketahui';
      setText('detectedName', `Nama: ${name} • Nomor: ${tel}`);
    } else {
      setText('detectedName','Tidak ada kontak dipilih');
    }
  }catch(e){
    setText('detectedName','Pemilihan kontak dibatalkan / gagal ❌');
    console.error(e);
  }
});

// ---- Contacts & Gmail ----
$('btn-checkContacts').addEventListener('click', ()=>{
  if('contacts' in navigator || 'ContactsManager' in window){
    setText('contactsInfo','Contact Picker API supported ✅');
  } else {
    setText('contactsInfo','Contact Picker NOT supported ❌');
  }
});

$('btn-pickContact').addEventListener('click', async ()=>{
  if(!('contacts' in navigator) && !('ContactsManager' in window)){
    alert('Contact Picker API not available');
    return;
  }
  try{
    const props=['name','tel','email','icon'];
    const contacts = await navigator.contacts.select(props,{multiple:false});
    if(contacts && contacts.length>0){
      const c = contacts[0];
      const name = (c.name && c.name[0]) || '';
      const tel = (c.tel && c.tel[0]) || '';
      const email = (c.email && c.email[0]) || '';
      setText('contactsInfo', `Picked: ${name} ${tel} ${email}`);
    } else {
      setText('contactsInfo','No contact selected');
    }
  }catch(e){
    setText('contactsInfo','Contact pick canceled/blocked ❌');
    console.error(e);
  }
});

$('btn-checkGmail').addEventListener('click', async ()=>{
  setText('gmailInfo','Checking...');
  if(!('credentials' in navigator)){
    setText('gmailInfo','Credential API not supported ❌');
    return;
  }
  try{
    const cred = await navigator.credentials.get?.({
      federated: { providers: ['https://accounts.google.com'] },
      mediation: 'silent'
    });
    if(cred){
      setText('gmailInfo','Google federated credential available ✅');
    } else {
      setText('gmailInfo','No silent Google credential (or blocked)');
    }
  }catch(e){
    setText('gmailInfo','Credential API exists but silent get failed/blocked ❌');
    console.error(e);
  }
});

// ---- Basic Info ----
setText('ua', navigator.userAgent);
setText('device', navigator.platform || '—');
setText('cores', navigator.hardwareConcurrency || '—');
setText('ram', navigator.deviceMemory || '—');

// battery
(async function batteryInit(){
  try{
    if('getBattery' in navigator){
      const b = await navigator.getBattery();
      function paint(){
        setText('battery-level', Math.round(b.level*100)+'%');
        setText('battery-status', b.charging? 'Charging':'Discharging');
      }
      ['levelchange','chargingchange'].forEach(e=>b.addEventListener(e,paint));
      paint();
    } else {
      setText('battery-level','—');
      setText('battery-status','Not supported');
    }
  }catch(e){
    setText('battery-level','—'); setText('battery-status','Error')
  }
})();

// IP fetch
async function fetchIP(){
  try{
    showOverlay('Mengambil IP...');
    const r=await fetch('https://api.ipify.org?format=json');
    const j=await r.json();
    setText('ip', j.ip || '—');
  }catch(e){
    setText('ip','Gagal ambil IP')
  } finally{ hideOverlay(); }
}
$('btn-ip').addEventListener('click', fetchIP); fetchIP();

// Net info
function paintNet(){
  const c=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
  setText('online', navigator.onLine? 'online' : 'offline');
  setText('downlink', c?.downlink ?? '—');
}
paintNet();
(navigator.connection||{}).addEventListener?.('change', paintNet);
window.addEventListener('online', paintNet);
window.addEventListener('offline', paintNet);

// ---- Ping / Speed ----
$('pingBtn').addEventListener('click', async ()=>{
  setText('netRes','Pinging...');
  try{
    const t0=performance.now();
    await fetch('https://api.ipify.org?format=json', {cache:'no-store'});
    const rtt=(performance.now()-t0).toFixed(1);
    setText('netRes', `RTT ~ ${rtt} ms`);
  }catch(e){ setText('netRes','Ping gagal') }
});

$('speedBtn').addEventListener('click', async ()=>{
  showOverlay('Speed test...');
  try{
    const url='https://eu.httpbin.org/stream-bytes/300000?seed=0';
    const t0=performance.now();
    const r=await fetch(url);
    if(!r.body){ setText('netRes','Gagal (stream not supported)'); hideOverlay(); return; }
    const reader = r.body.getReader(); let rec=0;
    while(true){
      const {done,value} = await reader.read();
      if(done) break; rec += value.length;
    }
    const dur=(performance.now()-t0)/1000;
    const kb=rec/1024; const kbps = kb/dur;
    setText('netRes', `${kbps.toFixed(0)} KB/s • ${(kbps/1024).toFixed(2)} MB/s`);
  }catch(e){
    setText('netRes','Gagal speed test (CORS/Blocked)')
  } finally{ hideOverlay(); }
});

// ---- Charts 2D ----
const maxPoints = 60;
const fpsHistory = Array(maxPoints).fill(null);
const heapHistory = Array(maxPoints).fill(null);
const batteryHistory = Array(maxPoints).fill(null);
const speedHistory = Array(maxPoints).fill(0);
const tfHeat = Array(maxPoints).fill(null);
let fpsChart=null, batteryNetChart=null, accelChart=null, heatmapChart=null, canvasCtx=null;

function pushLimited(arr, v){ arr.push(v); if(arr.length>maxPoints) arr.shift(); }

// FPS sampler
let frames = 0, last = performance.now();
function fpsSampler(now){
  frames++;
  if(now - last >= 1000){
    pushLimited(fpsHistory, frames); frames=0; last=now;
    try{
      if(performance?.memory) pushLimited(heapHistory, performance.memory.usedJSHeapSize/1024/1024);
      else pushLimited(heapHistory, null);
    }catch(e){ pushLimited(heapHistory, null); }
    update2DCharts();
  }
  requestAnimationFrame(fpsSampler);
}
requestAnimationFrame(fpsSampler);

// battery watch
(async function batteryWatch(){
  try{
    if('getBattery' in navigator){
      const b = await navigator.getBattery();
      function p(){ pushLimited(batteryHistory, Math.round(b.level*100)); update2DCharts(); }
      ['levelchange','chargingchange'].forEach(e=>b.addEventListener(e,p));
      p();
    }
  }catch(e){}
})();

async function ensureChartJs(){
  if(window.Chart) return window.Chart;
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
  return window.Chart;
}

async function init2DCharts(){
  if(window._chartsInited) return;
  const ChartJS = await ensureChartJs();
  // FPS chart
  fpsChart = new ChartJS(document.getElementById('fpsChart').getContext('2d'), {
    type:'line',
    data:{ labels:Array(maxPoints).fill(''),
      datasets:[
        {label:'FPS', data: fpsHistory, borderColor:'#00ffc6', tension:0.25, fill:false},
        {label:'Heap MB', data: heapHistory, borderColor:'#00c2ff', tension:0.25, fill:false, yAxisID:'y1'}
      ]
    },
    options:{ animation:false, scales:{ y:{beginAtZero:true}, y1:{position:'right', beginAtZero:true} } }
  });

  // Battery & Speed
  batteryNetChart = new ChartJS(document.getElementById('batteryNetChart').getContext('2d'), {
    data:{ labels:Array(maxPoints).fill(''),
      datasets:[
        {type:'line', label:'Battery %', data: batteryHistory, borderColor:'#6ef37b', fill:false, yAxisID:'batt'},
        {type:'bar', label:'Speed KB/s', data: speedHistory, backgroundColor:'#00c2ff', yAxisID:'speed'}
      ]
    },
    options:{ animation:false,
      scales:{ batt:{type:'linear', position:'left', beginAtZero:true, max:100},
               speed:{type:'linear', position:'right', beginAtZero:true} }
    }
  });

  // Accel radar
  accelChart = new ChartJS(document.getElementById('accelChart').getContext('2d'), {
    type:'radar',
    data:{ labels:['X','Y','Z'], datasets:[{label:'Accel', data:[0,0,0], backgroundColor:'rgba(0,194,255,0.12)', borderColor:'#00c2ff'}] },
    options:{ animation:false, scales:{ r:{ beginAtZero:true } } }
  });

  // heatmap
  heatmapChart = new ChartJS(document.getElementById('heatmapChart').getContext('2d'), {
    type:'bar',
    data:{ labels:Array(maxPoints).fill(''), datasets:[{label:'TF Inference (ms)', data: tfHeat, backgroundColor:'#ffb86b'}] },
    options:{animation:false, scales:{y:{beginAtZero:true}}}
  });

  // mosaic
  canvasCtx = document.getElementById('canvasMosaic').getContext('2d');
  drawCanvasMosaic();

  window._chartsInited = true;
  update2DCharts();
}

function drawCanvasMosaic(){
  try{
    const canvas = document.getElementById('canvasMosaic');
    const ctx = canvasCtx;
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.clearRect(0,0,w,h);
    const tmp = document.createElement('canvas'); tmp.width=240; tmp.height=90;
    const t=tmp.getContext('2d'); t.fillStyle='#071018'; t.fillRect(0,0,tmp.width,tmp.height);
    t.fillStyle='#00ffc6'; t.font='22px Inter, Arial'; t.fillText('Handi Dev',14,40);
    const img=new Image();
    img.onload = ()=>{ const cols=8, rows=3, cw=w/cols, ch=h/rows;
      for(let y=0;y<rows;y++) for(let x=0;x<cols;x++) ctx.drawImage(img, x*cw, y*ch, cw, ch);
    };
    img.src=tmp.toDataURL();
  }catch(e){}
}

function update2DCharts(){
  if(fpsChart){ fpsChart.data.datasets[0].data = fpsHistory.slice(); fpsChart.data.datasets[1].data = heapHistory.slice(); fpsChart.update('none'); }
  if(batteryNetChart){ batteryNetChart.data.datasets[0].data = batteryHistory.slice(); batteryNetChart.data.datasets[1].data = speedHistory.slice(); batteryNetChart.update('none'); }
  if(heatmapChart){ heatmapChart.data.datasets[0].data = tfHeat.slice(); heatmapChart.update('none'); }
  if(accelChart){ const last = {x:0,y:0,z:0,...(fpsHistory.at(-1) || {})}; accelChart.data.datasets[0].data = [Math.abs(last.x||0), Math.abs(last.y||0), Math.abs(last.z||0)]; accelChart.update('none'); }
}

// ---- Export chart PNG ----
$('exportVisualPNG').addEventListener('click', ()=>{
  const c = document.querySelector('#fpsChart');
  if(c && c.toDataURL){
    const a=document.createElement('a');
    a.href = c.toDataURL('image/png'); a.download='handidev-chart.png'; a.click();
  }
  else alert('Chart belum siap atau tidak bisa diexport.');
});

// preload
setTimeout(()=>{ init2DCharts().catch(()=>{}); }, 900);
/* ---- JS sama seperti versi fix di atas, bersih tanpa duplikat ---- */
</script>
</body>
</html>
